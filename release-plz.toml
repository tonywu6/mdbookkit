[workspace]
release_always = false

[[package]]
name = "mdbookkit"
semver_check = false # doesn't make sense yet for the current lib

[changelog]
header = """# CHANGELOG

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

This file is autogenerated using [release-plz](https://release-plz.dev).

"""

body = """

{%- macro print_commit(commit) -%}
  - {% if commit.breaking %}[**breaking**] {% endif %}\
    {{ commit.message }} \
    [`{{ commit.id | truncate(length=7, end="") }}`]({{ remote.link }}/commit/{{ commit.id }})\
    {%- raw %}\n{% endraw -%}
{%- endmacro -%}

{%- macro print_scope(commits) -%}
  {%- for group, commits in commits | group_by(attribute="group") -%}
    #### {{ group }} {%- raw %}\n\n{% endraw -%}

      {%- for commit in commits
        | filter(attribute="merge_commit", value=false)
        | unique(attribute="message") -%}
        {{- self::print_commit(commit=commit) -}}
      {%- endfor -%}

    {%- raw %}\n{% endraw -%}
  {%- endfor -%}
{%- endmacro -%}

{%- if version -%}
  {%- if previous.version -%}
    ## [{{ version | trim_start_matches(pat="v") }}]({{ release_link }})
  {%- else -%}
    ## [{{ version | trim_start_matches(pat="v") }}]
  {%- endif -%}
{%- endif -%}
{%- raw %}\n\n{% endraw -%}

{%- for scope, commits in commits
  | group_by(attribute="scope") -%}
  ### {{ scope | striptags | trim }} {%- raw %}\n\n{% endraw -%}
    {{- self::print_scope(commits=commits) -}}
{%- endfor -%}
"""

commit_parsers = [
  { message = "^feat", group = "<!-- 0 --> Features" },
  { message = "^fix", group = "<!-- 1 --> Bug fixes" },
  { message = "^refactor\\(clippy\\)", skip = true },
  { message = "^refactor", group = "<!-- 2 --> Refactor" },
  { message = "^doc", group = "<!-- 3 --> Documentation" },
  { message = "^perf", group = "<!-- 4 --> Performance" },
  { message = "^chore\\(release\\):", skip = true },
  { message = "^chore: release", skip = true },
  { message = "^chore\\(deps.*\\)", skip = true },
  { message = "^chore\\(pr\\)", skip = true },
  { message = "^chore\\(pull\\)", skip = true },
  { message = "^chore|^ci|^test", group = "<!-- 5 --> Miscellaneous" },
  { body = ".*security", group = "<!-- 6 --> Security" },
  { message = "^revert", group = "<!-- 7 --> Reverted" },
]

link_parsers = [{ pattern = "#(\\d+)", href = "{{ remote.link }}/issues/$1" }]
