[workspace]
git_release_name = "{{ package }} {{ version }}"
git_tag_name = "{{ package }}-v{{ version }}"
release_always = true

[[package]]
git_release_enable = false
name = "mdbookkit"
semver_check = false

[[package]]
name = "mdbook-rustdoc-links"
semver_check = false

[[package]]
name = "mdbook-permalinks"
semver_check = false

[changelog]
header = """# CHANGELOG

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

This file is autogenerated using [release-plz](https://release-plz.dev).

"""

body = """

{%- macro print_commit(commit) -%}

  - {% if commit.breaking %}**\\[BREAKING\\]** {% endif %}\
    {{ commit.message }} \
    [`{{ commit.id | truncate(length=7, end="") }}`]({{ remote.link }}/commit/{{ commit.id }})\
    {%- raw %}\n\n{% endraw -%}

{%- endmacro -%}

{%- if version -%}
  ## {{ version | trim_start_matches(pat="v") }}

  {%- if previous.version -%}
    {%- raw %}\n\n{% endraw -%}
    [v{{ previous.version }}..v{{ version }}]({{ release_link }})
  {%- endif -%}

  {%- raw %}\n\n{% endraw -%}
{%- endif -%}

{%- raw %}\n\n{% endraw -%}

{%- for group, commits in commits | group_by(attribute="group") -%}
  ### {{ group }} {%- raw %}\n\n{% endraw -%}

  {%- for commit in commits
    | filter(attribute="merge_commit", value=false)
    | unique(attribute="message") -%}
    {{- self::print_commit(commit=commit) -}}
  {%- endfor -%}

{%- endfor -%}
"""

link_parsers = [{ pattern = "#(\\d+)", href = "{{ remote.link }}/issues/$1" }]

postprocessors = [
  { pattern = ".*", replace_command = "pnpm exec prettier --parser markdown --prose-wrap never" },
]

[[changelog.commit_parsers]]
group = "<!-- 0 --> Added"
message = "^feat"

[[changelog.commit_parsers]]
group = "<!-- 1 --> Fixed"
message = "^fix"

[[changelog.commit_parsers]]
group = "<!-- 2 --> Changed"
message = "^refactor|^perf|^revert"

[[changelog.commit_parsers]]
group = "<!-- 3 --> Documented"
message = "^docs"

[[changelog.commit_parsers]]
message = "^chore|^ci|^test"
skip = true
