[workspace]
release_always = true

[[package]]
name = "mdbookkit"
semver_check = false

[[package]]
name = "mdbook-rustdoc-links"
semver_check = false

[[package]]
name = "mdbook-permalinks"
semver_check = false

[changelog]
header = """# CHANGELOG

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

This file is autogenerated using [release-plz](https://release-plz.dev).

"""

body = """

{%- macro print_commit(commit) -%}
  - {% if commit.breaking %}[**breaking**] {% endif %}\
    {{ commit.message }} \
    [`{{ commit.id | truncate(length=7, end="") }}`]({{ remote.link }}/commit/{{ commit.id }})\
    {%- raw %}\n{% endraw -%}
{%- endmacro -%}

{%- macro print_scope(commits) -%}
  {%- for group, commits in commits | group_by(attribute="group") -%}
    ### {{ group }} {%- raw %}\n\n{% endraw -%}

      {%- for commit in commits
        | filter(attribute="merge_commit", value=false)
        | unique(attribute="message") -%}
        {{- self::print_commit(commit=commit) -}}
      {%- endfor -%}

    {%- raw %}\n{% endraw -%}
  {%- endfor -%}
{%- endmacro -%}

{%- if version -%}
  {%- if previous.version -%}
    ## [{{ version | trim_start_matches(pat="v") }}]({{ release_link }})
  {%- else -%}
    ## [{{ version | trim_start_matches(pat="v") }}]
  {%- endif -%}
{%- endif -%}
{%- raw %}\n\n{% endraw -%}

{%- for commits in commits -%}
  {{- self::print_scope(commits=commits) -}}
{%- endfor -%}
"""

link_parsers = [{ pattern = "#(\\d+)", href = "{{ remote.link }}/issues/$1" }]

[[changelog.commit_parsers]]
group = "<!-- 0 --> Features"
message = "^feat"

[[changelog.commit_parsers]]
group = "<!-- 1 --> Bug fixes"
message = "^fix"

[[changelog.commit_parsers]]
default_scope = "Other changes"
group = "<!-- 2 --> Refactor"
message = "^refactor"

[[changelog.commit_parsers]]
default_scope = "Other changes"
group = "<!-- 3 --> Documentation"
message = "^docs"

[[changelog.commit_parsers]]
default_scope = "Other changes"
group = "<!-- 4 --> Performance"
message = "^perf"

[[changelog.commit_parsers]]
default_scope = "Other changes"
group = "<!-- 5 --> Miscellaneous"
message = "^chore|^ci|^test"

[[changelog.commit_parsers]]
message = "^chore: release"
skip = true

[[changelog.commit_parsers]]
body = ".*security"
default_scope = "Other changes"
group = "<!-- 6 --> Security"

[[changelog.commit_parsers]]
group = "<!-- 7 --> Reverted"
message = "^revert"

[[changelog.commit_preprocessors]]
pattern = "^chore\\(ci\\):"
replace = "ci:"
